/*******************************************************************
 *                                                                 *
 * Copyright IBM Corp. 2015                                        *
 *                                                                 *
 *******************************************************************/
package com.ibm.research.drl.dpt.vulnerability.fpvi;

import com.ibm.research.drl.dpt.datasets.IPVDataset;
import com.ibm.research.drl.dpt.vulnerability.IPVVulnerability;
import com.ibm.research.drl.dpt.vulnerability.brute.Brute;
import org.junit.jupiter.api.Disabled;
import org.junit.jupiter.api.Test;

import java.io.InputStream;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.List;

import static java.time.Duration.ofMillis;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.Matchers.is;
import static org.junit.jupiter.api.Assertions.*;


public class FPVITest {
    @Test
    @Disabled("test too slow to be unit-tested")
    public void testOnDataLarger() throws Exception {
        try (InputStream inputStream = FPVITest.class.getResourceAsStream("/adult-15-45000.data")) {
            IPVDataset dataset = IPVDataset.load(inputStream, false, ',', '"', false);

            FPVI algorithm = new FPVI(2, 100, 1.5, 2);
            Collection<IPVVulnerability> vulnerabilities = algorithm.apply(dataset);

            for (IPVVulnerability vulnerability : vulnerabilities) {
                System.out.println(vulnerability);
            }
        }
    }

    @Test
    @Disabled
    public void testCorrectness() {
        assertTimeout(ofMillis(5L * 60L * 1000L), () -> {
            try (InputStream inputStream = FPVITest.class.getResourceAsStream("/adult-10-30000.data.csv")) {
                IPVDataset dataset = IPVDataset.load(inputStream, false, ',', '"', false);

                int k = 2;

                Brute brute = new Brute(k);
                Collection<IPVVulnerability> bruteVulnerabilities = brute.apply(dataset);

                FPVI algorithm = new FPVI(4, 5000, 1, k);
                Collection<IPVVulnerability> vulnerabilities = algorithm.apply(dataset);

                assertEquals(vulnerabilities.size(), bruteVulnerabilities.size());

                for (IPVVulnerability vulnerability : vulnerabilities) {
                    assertTrue(bruteVulnerabilities.contains(vulnerability));
                }
            }
        });
    }

    @Test
    public void testOnData() throws Exception {
        final List<String> expectedResults = new ArrayList<>(Arrays.asList(
                "[0]",
                "[3]",
                "[1,4]",
                "[2,4]"
        ));

        IPVDataset dataset = IPVDataset.load(FPVITest.class.getResourceAsStream("/100.csv"), false, ',', '"', false);

        for(int i = 0; i < 1000; i++) {
            FPVI algorithm = new FPVI(1, 1000, 1.5, 3);
            Collection<IPVVulnerability> vulnerabilities = algorithm.apply(dataset);

            assertThat(vulnerabilities.size(), is(expectedResults.size()));

            for (IPVVulnerability vulnerability : vulnerabilities) {
                String vul = vulnerability.toString();
                assertTrue(expectedResults.contains(vul));
            }
        }
    }
}


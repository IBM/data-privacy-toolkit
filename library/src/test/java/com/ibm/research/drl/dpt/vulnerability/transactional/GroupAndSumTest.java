/*******************************************************************
 *                                                                 *
 * Copyright IBM Corp. 2021                                        *
 *                                                                 *
 *******************************************************************/
package com.ibm.research.drl.dpt.vulnerability.transactional;

import com.ibm.research.drl.dpt.datasets.IPVDataset;
import org.junit.jupiter.api.Test;

import java.io.InputStream;
import java.util.List;
import java.util.Map;

import static org.junit.jupiter.api.Assertions.assertEquals;


public class GroupAndSumTest {

    @Test
    public void testGroupAndSum() throws Exception {
        try (InputStream inputStream = GroupAndSumTest.class.getResourceAsStream("/testGroupBy.csv")) {
            IPVDataset dataset = IPVDataset.load(inputStream, false, ',', '"', false);

            Map<String, Double> values = GroupAndSum.groupAndSum(dataset, 0, 1);
            assertEquals(2, values.size());
            assertEquals(7.0, values.get("user1"), 0.000000001);
            assertEquals(5.0, values.get("user2"), 0.000000001);
        }
    }

    @Test
    public void testOffendingRows() throws Exception {
        try (InputStream inputStream = GroupAndSumTest.class.getResourceAsStream("/testGroupBy.csv")) {
            IPVDataset dataset = IPVDataset.load(inputStream, false, ',', '"', false);

            List<Integer> offendingRows = GroupAndSum.offendingTransactions(dataset, 0, 1, 6.0);
            //0, 1, 3, 5
            assertEquals(4, offendingRows.size());
            assertEquals(0, offendingRows.get(0).intValue());
            assertEquals(1, offendingRows.get(1).intValue());
            assertEquals(3, offendingRows.get(2).intValue());
            assertEquals(5, offendingRows.get(3).intValue());
        }
    }
}